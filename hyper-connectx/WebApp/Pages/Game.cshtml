@page "{id}"
@using BLL
@model WebApp.Pages.GameModel
@{
    ViewData["Title"] = "Game";
    var width = Model.GetBoardWidth();
    var height = Model.GetBoardHeight();
    var isGameOver = Model.Winner != null || Model.IsDraw;
}

<style>
    .game-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 1rem;
        text-align: center;
        font-family: Arial, sans-serif;
    }
    
    .game-container h1 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }
    
    .game-status {
        font-size: 1.5rem;
        font-weight: bold;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    .game-status.winner-x {
        background-color: #ffebee;
        color: #c62828;
    }
    
    .game-status.winner-o {
        background-color: #fff9c4;
        color: #f57f17;
    }
    
    .game-status.draw {
        background-color: #e0e0e0;
        color: #424242;
    }
    
    .game-info {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin: 1rem 0;
        font-size: 1.1rem;
    }
    
    .badge {
        background-color: #4caf50;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.9rem;
    }
    
    .column-buttons {
        display: grid;
        gap: 0.5rem;
        margin: 1rem auto;
    }
    
    .column-btn {
        background-color: #2196f3;
        color: white;
        border: none;
        padding: 0.5rem;
        font-size: 1.2rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .column-btn:hover {
        background-color: #1976d2;
    }
    
    .ai-turn {
        margin: 1rem 0;
        padding: 1rem;
        background-color: #fff3e0;
        border-radius: 8px;
    }
    
    .game-board {
        display: inline-grid;
        gap: 8px;
        padding: 20px;
        background: linear-gradient(to bottom, #1976d2, #1565c0);
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        margin: 1rem auto;
    }
    
    .cell {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: #fff;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .cell.player-x {
        background: radial-gradient(circle, #ef5350, #c62828);
        box-shadow: 0 4px 8px rgba(239, 83, 80, 0.4), inset 0 2px 4px rgba(255,255,255,0.3);
    }
    
    .cell.player-o {
        background: radial-gradient(circle, #ffeb3b, #f57f17);
        box-shadow: 0 4px 8px rgba(255, 235, 59, 0.4), inset 0 2px 4px rgba(255,255,255,0.3);
    }
    
    .cell.ghost-x {
        background: radial-gradient(circle, rgba(239, 83, 80, 0.7), rgba(198, 40, 40, 0.7));
        box-shadow: 0 4px 8px rgba(239, 83, 80, 0.5);
    }
    
    .cell.ghost-o {
        background: radial-gradient(circle, rgba(255, 235, 59, 0.7), rgba(245, 127, 23, 0.7));
        box-shadow: 0 4px 8px rgba(255, 235, 59, 0.5);
    }
    
    .cell.winning {
        animation: pulse 1s infinite;
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.8) !important;
    }
    
    .cell:hover {
        cursor: pointer;
        opacity: 0.9;
        transform: scale(1.05);
    }
    
    /* Column highlight - subtle glow effect instead of filled background */
    .cell.column-highlight {
        box-shadow: 0 0 8px rgba(33, 150, 243, 0.6), 0 0 16px rgba(33, 150, 243, 0.3);
    }
    
    .cell.column-highlight.ghost-x {
        box-shadow: 0 0 8px rgba(239, 83, 80, 0.7), 0 0 16px rgba(239, 83, 80, 0.4);
    }
    
    .cell.column-highlight.ghost-o {
        box-shadow: 0 0 8px rgba(255, 235, 59, 0.7), 0 0 16px rgba(255, 235, 59, 0.4);
    }
    
    .cell.column-highlight.player-x {
        box-shadow: 0 0 10px rgba(239, 83, 80, 0.6), 0 0 20px rgba(239, 83, 80, 0.3);
    }
    
    .cell.column-highlight.player-o {
        box-shadow: 0 0 10px rgba(255, 235, 59, 0.6), 0 0 20px rgba(255, 235, 59, 0.3);
    }
    
    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .game-actions {
        margin: 2rem 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s;
    }
    
    .btn-primary {
        background-color: #4caf50;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #45a049;
    }
    
    .btn-secondary {
        background-color: #757575;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #616161;
    }
    
    .btn-warning {
        background-color: #ff9800;
        color: white;
        padding: 1rem 2rem;
        font-size: 1.1rem;
    }
    
    .btn-warning:hover {
        background-color: #f57c00;
    }
    
    .btn-info {
        background-color: #2196f3;
        color: white;
    }
    
    .btn-info:hover {
        background-color: #1976d2;
    }
    
    .save-form {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .form-control {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
    }
</style>

<div class="game-container">
    <h1>HyperConnectX</h1>
    
    <!-- Game Status -->
    <div class="game-status @GetStatusClass()">
        @Model.GameMessage
    </div>

    <!-- Game Info -->
    <div class="game-info">
        <span><strong>@(string.IsNullOrEmpty(Model.GameState.P1Name) ? "Player 1" : Model.GameState.P1Name)</strong> (X - Red)</span>
        <span>vs</span>
        <span><strong>@(string.IsNullOrEmpty(Model.GameState.P2Name) ? "Player 2" : Model.GameState.P2Name)</strong> (O - Yellow)</span>
        @if (Model.GameState.Configuration?.IsCylindrical == true)
        {
            <span class="badge">Cylindrical</span>
        }
    </div>

    <!-- Column Buttons (for making moves) -->
    @if (!isGameOver && !Model.IsAiTurn)
    {
        <div class="column-buttons" style="grid-template-columns: repeat(@width, 1fr); max-width: @(width * 70)px;">
            @for (int x = 0; x < width; x++)
            {
                var col = x;
                <form method="post" asp-page-handler="Move" style="display:inline;">
                    <input type="hidden" name="column" value="@col" />
                    <button type="submit" class="column-btn" title="Drop in column @(col + 1)">
                        â–¼
                    </button>
                </form>
            }
        </div>
    }

    <!-- Hidden move form for JavaScript cell clicks -->
    @if (!isGameOver && !Model.IsAiTurn)
    {
        <form method="post" asp-page-handler="Move" id="moveForm">
            <input type="hidden" name="column" id="moveColumn" />
        </form>
    }

    <!-- CvC Auto-play Form (hidden, auto-submits via JavaScript) -->
    @if (!isGameOver && Model.IsCvCMode && Model.IsAiTurn)
    {
        <form method="post" asp-page-handler="AiMove" id="cvcAutoPlayForm"></form>
        <script>setTimeout(function() { document.getElementById('cvcAutoPlayForm').submit(); }, 1000);</script>
    }
    @if (!isGameOver && Model.IsAiTurn)
    {
        <div class="ai-turn">
            @if (Model.IsCvCMode)
            {
                <p>ðŸ¤– Computers are playing...</p>
                <script>setTimeout(function() { document.querySelector('form[asp-page-handler="AiMove"] button').click(); }, 1000);</script>
            }
            else
            {
                <p>Computer is thinking...</p>
                <form method="post" asp-page-handler="AiMove" id="pvcAutoPlayForm"></form>
                <script>setTimeout(function() { document.getElementById('pvcAutoPlayForm').submit(); }, 1000);</script>
            }
        </div>
    }

    <!-- Hidden game state for JavaScript -->
    @if (!isGameOver)
    {
        <div id="gameState" data-next-player-x="@Model.Brain.IsNextPlayerX().ToString().ToLower()" data-is-ai-turn="@Model.IsAiTurn.ToString().ToLower()" style="display:none;"></div>
    }
    
    <!-- Game Board -->
    <div class="game-board" style="grid-template-columns: repeat(@width, 60px); grid-template-rows: repeat(@height, 60px);">
        @for (int y = 0; y < height; y++)
        {
            @for (int x = 0; x < width; x++)
            {
                var cell = Model.GetCell(x, y);
                var isWin = Model.IsWinningCell(x, y);
                <div class="cell @GetCellClass(cell) @(isWin ? "winning" : "")" data-column="@x"></div>
            }
        }
    </div>

    <!-- Game Actions -->
    <div class="game-actions">
        @if (isGameOver)
        {
            <a asp-page="/NewGame" class="btn btn-primary">New Game</a>
        }
        <a asp-page="/Index" class="btn btn-secondary">Back to Home</a>
        
        @if (!isGameOver)
        {
            <form method="post" asp-page-handler="Save" class="save-form">
                <input type="text" name="saveName" placeholder="Save name..." 
                       value="@Model.GameState.SaveName" class="form-control" />
                <button type="submit" class="btn btn-info">Save Game</button>
            </form>
        }
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const gameBoard = document.querySelector('.game-board');
        const moveForm = document.getElementById('moveForm');
        const moveColumn = document.getElementById('moveColumn');
        const gameState = document.getElementById('gameState');
        
        // Track current hover state and ghost cell
        let currentHoveredColumn = null;
        let ghostCell = null;
        let highlightedColumn = null;
        
        // Check if we should show ghost pieces
        function canShowGhost() {
            if (!gameState) return false;
            const isGameOver = document.querySelector('.game-status.winner-x, .game-status.winner-o, .game-status.draw');
            if (isGameOver) return false;
            return gameState.dataset.isAiTurn === 'false';
        }
        
        // Get all cells in a column
        function getCellsInColumn(column) {
            return Array.from(document.querySelectorAll(`.cell[data-column="${column}"]`));
        }
        
        // Highlight all cells in a column
        function highlightColumn(column) {
            if (highlightedColumn === column) return;
            removeColumnHighlight();
            
            const cells = getCellsInColumn(column);
            cells.forEach(cell => {
                cell.classList.add('column-highlight');
            });
            highlightedColumn = column;
        }
        
        // Remove column highlight from all cells
        function removeColumnHighlight() {
            if (highlightedColumn !== null) {
                const cells = getCellsInColumn(highlightedColumn);
                cells.forEach(cell => {
                    cell.classList.remove('column-highlight');
                });
                highlightedColumn = null;
            }
        }
        
        // Find the bottom-most empty cell in a column
        function findBottomEmptyCell(column) {
            const cells = getCellsInColumn(column);
            // Cells are rendered top-to-bottom, so iterate in reverse
            for (let i = cells.length - 1; i >= 0; i--) {
                const cell = cells[i];
                if (!cell.classList.contains('player-x') && !cell.classList.contains('player-o')) {
                    return cell;
                }
            }
            return null;
        }
        
        // Show ghost piece
        function showGhost(column) {
            if (!canShowGhost()) return;
            
            const ghostTarget = findBottomEmptyCell(column);
            if (ghostTarget) {
                const isNextPlayerX = gameState.dataset.nextPlayerX === 'true';
                ghostTarget.classList.add('ghost');
                ghostTarget.classList.add(isNextPlayerX ? 'ghost-x' : 'ghost-o');
                ghostCell = ghostTarget;
            }
        }
        
        // Remove ghost piece
        function removeGhost() {
            if (ghostCell) {
                ghostCell.classList.remove('ghost', 'ghost-x', 'ghost-o');
                ghostCell = null;
            }
        }
        
        // Handle column hover
        function handleColumnEnter(column) {
            if (column !== currentHoveredColumn) {
                removeGhost();
                currentHoveredColumn = column;
                highlightColumn(column);
                showGhost(column);
            }
        }
        
        function handleColumnLeave() {
            removeGhost();
            removeColumnHighlight();
            currentHoveredColumn = null;
        }
        
        // Attach event listeners to cells
        if (gameBoard) {
            const cells = gameBoard.querySelectorAll('.cell');
            cells.forEach(cell => {
                cell.addEventListener('mouseenter', function() {
                    if (this.dataset.column !== undefined) {
                        handleColumnEnter(this.dataset.column);
                    }
                });
                
                cell.addEventListener('mouseleave', function() {
                    // Only remove if we're leaving to a non-cell element
                    if (!this.closest('.cell:hover')) {
                        handleColumnLeave();
                    }
                });
            });
            
            // Also handle mouse leave from the entire board
            gameBoard.addEventListener('mouseleave', handleColumnLeave);
        }
        
        // Handle clicks
        if (gameBoard && moveForm && moveColumn) {
            gameBoard.addEventListener('click', function(e) {
                const cell = e.target.closest('.cell');
                if (cell && cell.dataset.column !== undefined) {
                    moveColumn.value = cell.dataset.column;
                    moveForm.submit();
                }
            });
        }
    });
</script>

@functions {
    string GetCellClass(ECellState cell)
    {
        return cell switch
        {
            ECellState.X => "player-x",
            ECellState.O => "player-o",
            ECellState.XWin => "player-x win-x",
            ECellState.OWin => "player-o win-o",
            _ => ""
        };
    }

    string GetStatusClass()
    {
        if (Model.Winner == ECellState.X || Model.Winner == ECellState.XWin) return "winner-x";
        if (Model.Winner == ECellState.O || Model.Winner == ECellState.OWin) return "winner-o";
        if (Model.IsDraw) return "draw";
        return "player-turn";
    }
}
